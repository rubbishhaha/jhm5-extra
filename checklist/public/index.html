<!doctype html>
<html lang="zh-Hant">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Past Paper Checklist</title>
		<style>
/* ================================ */
/* 極簡設計系統 - 黑白配色 */
/* ================================ */
:root {
	/* 極簡色彩系統 */
	--color-black: #000000;
	--color-white: #ffffff;
	--color-gray-light: #f5f5f5;
	--color-gray-border: #e5e5e5;
	--color-success: #059669;
	--color-danger: #dc2626;
  
	/* 間距系統 */
	--space-xs: 4px;
	--space-sm: 8px;
	--space-md: 16px;
	--space-lg: 24px;
	--space-xl: 32px;
  
	/* 字型系統 */
	--font-body: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
}

/* ================================ */
/* 基礎重置 */
/* ================================ */
*, *::before, *::after { 
	box-sizing: border-box; 
}

body { 
	margin: 0;
	padding: 0;
	font-family: var(--font-body);
	background: var(--color-white);
	color: var(--color-black);
	line-height: 1.6;
}

/* ================================ */
/* 佈局系統 */
/* ================================ */
.container { 
	max-width: 1200px; 
	margin: 0 auto; 
	padding: var(--space-md); 
}

.grid { 
	display: grid; 
	gap: var(--space-lg); 
}

.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }

/* 響應式 */
@media (max-width: 768px) {
	.grid-2, .grid-3 { 
		grid-template-columns: 1fr; 
	}
}

/* ================================ */
/* 按鈕系統 - 統一44px高度 */
/* ================================ */
.btn {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	min-height: 44px;
	min-width: 70px;
	padding: var(--space-sm) var(--space-md);
	border: 2px solid var(--color-black);
	background: var(--color-white);
	color: var(--color-black);
	text-decoration: none;
	font-size: 14px;
	font-weight: 500;
	cursor: pointer;
	transition: all 0.15s;
	border-radius: 0;
	white-space: nowrap;
	line-height: 1;
	box-sizing: border-box;
}

.btn:hover {
	background: var(--color-black);
	color: var(--color-white);
	transform: translateY(-2px);
}

.btn:active {
	transform: translateY(0);
}

/* 返回按鈕 - 統一樣式和位置（未使用但保留） */
.back-btn {
	position: absolute;
	top: 10px;
	left: 10px;
	z-index: 100;
	min-height: 40px;
	min-width: 80px;
	padding: 8px 12px;
	font-size: 14px;
	font-weight: 500;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	line-height: 1;
}

@media (max-width: 768px) {
	body:has(.back-btn) .container,
	body:has(.back-btn) .app-container {
		padding-top: var(--space-xl);
	}
}

/* ================================ */
/* 卡片系統 */
/* ================================ */
.card {
	background: var(--color-white);
	border: 2px solid var(--color-black);
	padding: var(--space-xl);
	transition: transform 0.15s;
}

.card:hover {
	transform: translateY(-4px);
}

.card h3 {
	margin: 0 0 var(--space-sm);
	font-size: 20px;
	font-weight: 600;
}

.card .controls {
	margin-bottom: var(--space-md);
}

.table-wrap {
	overflow-x: auto;
}

table { border-collapse: collapse; width: 100%; min-width: 720px; }
th, td { border: 1px solid var(--color-gray-border); padding: 8px; text-align: center; }
th { background: var(--color-gray-light); }
.year-cell { min-width: 48px; }

.box.btn[aria-pressed="true"] {
	background: var(--color-black);
	color: var(--color-white);
}

/* ================================ */
/* 載入動效與骨架樣式 */
/* ================================ */
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); border: 0; white-space: nowrap; }

@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
	width: 16px; height: 16px;
	border: 2px solid var(--color-gray-border);
	border-top-color: var(--color-black);
	border-radius: 50%;
	display: inline-block;
	animation: spin 0.8s linear infinite;
}

@keyframes shimmer { 100% { transform: translateX(100%); } }
.skeleton { position: relative; overflow: hidden; background: var(--color-gray-light); color: transparent !important; }
.skeleton::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(0,0,0,0.06), transparent); animation: shimmer 1.2s infinite; }

/* 清除時的提示閃爍 */
@keyframes flash { 0% { background: #fffbe6; } 100% { background: transparent; } }
.flash-clear { animation: flash 0.4s ease-in-out; }

/* ================================ */
/* 應用頁面統一容器 */
/* ================================ */
.app-container {
	max-width: 1200px;
	margin: 0 auto;
	padding: var(--space-md);
}

.text-center { text-align: center; }
.mt-sm { margin-top: var(--space-sm); }
.mb-md { margin-bottom: var(--space-md); }
.hidden { display: none; }
		</style>
	</head>
	<body>
		<div class="app-container">
			<h1 class="text-center">試卷完成清單</h1>
			<p class="text-center mb-md">record your progress</p>
			<div id="cards" class="grid"></div>
		</div>

		<script>
			// Subjects
			const subjects = [
				{ id: 'Chinese', name: 'Chinese' },
				{ id: 'English', name: 'English' },
				{ id: 'Mathematics', name: 'Mathematics' },
				{ id: 'M2', name: 'M2' },
				{ id: 'Chemistry', name: 'Chemistry' },
				{ id: 'Physics', name: 'Physics' },
			];

			const startYear = 2012;
			const endYear = 2026;

			const cardsEl = document.getElementById('cards');

			// Build a card per subject
			for (const s of subjects) {
				const card = document.createElement('div');
				card.className = 'card';
				card.dataset.subject = s.id;
				card.innerHTML = `
					<h3>${s.name}</h3>
					<div class="controls">
						<button class="btn delete-all" data-subject="${s.id}">全部清除</button>
					</div>
					<div class="table-wrap">
						<table class="checklist-table" aria-label="${s.name} past papers checklist">
							<thead>
								<tr>
									<th>科目</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>${s.name}</td>
								</tr>
							</tbody>
						</table>
					</div>
				`;
				cardsEl.appendChild(card);

				const table = card.querySelector('table');
				const headerRow = table.querySelector('thead tr');
				const bodyRow = table.querySelector('tbody tr');

								// Build year headers and cells
				for (let y = startYear; y <= endYear; y++) {
					const th = document.createElement('th');
					th.className = 'year-cell';
					th.innerText = String(y);
					headerRow.appendChild(th);

					const td = document.createElement('td');
					td.className = 'year-cell';
					td.dataset.year = String(y);
					const box = document.createElement('button');
									box.className = 'btn box skeleton';
					box.setAttribute('aria-pressed', 'false');
									// show loading spinner initially and disable interactions
									box.innerHTML = '<span class="spinner" aria-hidden="true"></span><span class="sr-only">載入中…</span>';
							box.disabled = true;
					box.addEventListener('click', (e) => onBoxClick(e, s.id));
					td.appendChild(box);
					bodyRow.appendChild(td);
				}
			}

			// Load initial state per subject
							async function loadState(subject) {
								const res = await fetch('/api/get?subject=' + encodeURIComponent(subject));
								const card = document.querySelector('.card[data-subject="' + subject + '"]');
								if (!card) return;
								let payload = { years: {} };
								if (res.ok) {
									try { payload = await res.json(); } catch (_) {}
								}
								// Apply state for all years and enable buttons
								for (let y = startYear; y <= endYear; y++) {
									const btn = card.querySelector('td[data-year="' + y + '"] .box');
									if (!btn) continue;
									const done = !!(payload.years && payload.years[String(y)]);
									setChecked(btn, done, false, subject);
									btn.disabled = false;
									btn.classList.remove('skeleton');
									btn.innerHTML = btn.innerText; // ensure innerHTML is plain symbol after skeleton
								}
							}

			// Set UI checked state and optionally send to server
					async function setChecked(btn, checked, send = true, subjectOverride) {
				btn.setAttribute('aria-pressed', checked ? 'true' : 'false');
						// Use actual symbols instead of unicode escapes
						btn.innerText = checked ? '✓' : '□';
				const year = btn.parentElement.dataset.year;
				const card = btn.closest('.card');
				const subject = subjectOverride || (card ? card.dataset.subject : 'Chinese');
				if (send) {
					await fetch('/api/set', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ subject, year, done: checked }) });
				}
			}

			async function onBoxClick(e, subject) {
				const btn = e.currentTarget;
				const currently = btn.getAttribute('aria-pressed') === 'true';
						btn.disabled = true;
						try {
							if (!currently) {
								await setChecked(btn, true, true, subject);
							} else {
								const ok = confirm('確定要取消標記 ' + subject + ' ' + btn.parentElement.dataset.year + ' 嗎？');
								if (ok) {
									await setChecked(btn, false, true, subject);
								}
							}
						} finally {
							btn.disabled = false;
						}
			}

					// Delete all per subject (event delegation)
			cardsEl.addEventListener('click', async (e) => {
				const target = e.target;
				if (target && target.classList.contains('delete-all')) {
					const subject = target.getAttribute('data-subject');
					const ok = confirm('確定要全部清除 ' + subject + ' 的標記嗎？此動作會清除整列。');
					if (!ok) return;
							const card = document.querySelector('.card[data-subject="' + subject + '"]');
							if (!card) return;
							const boxes = Array.from(card.querySelectorAll('td[data-year] .box'));
							// Optimistic UI: immediately clear UI and disable during request
							boxes.forEach((b) => {
								setChecked(b, false, false, subject);
								b.classList.add('flash-clear');
								b.disabled = true;
							});
										try {
											const res = await fetch('/api/clear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ subject }) });
											if (!res.ok) throw new Error('clear failed');
											// Ensure state is fully refreshed so boxes are clickable again
											await loadState(subject);
										} catch (err) {
								alert('清除失敗，將回復原狀');
								// reload this subject state to restore
								await loadState(subject);
								return;
							} finally {
								// re-enable boxes
								boxes.forEach((b) => { b.disabled = false; setTimeout(() => b.classList.remove('flash-clear'), 450); });
							}
				}
			});

			// Initialize: load each subject state
			Promise.all(subjects.map(s => loadState(s.id))).catch(err => console.error(err));
		</script>
	</body>
	</html>
